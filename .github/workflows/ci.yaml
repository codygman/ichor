name: CI
on: push
env:
  CABAL_DIR: ${{ github.workspace }}/.cabal
  ACTIONS_ALLOW_UNSECURE_COMMANDS: true
jobs:
  tests:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2.3.4
    - uses: cachix/install-nix-action@v12
      with:
        nix_path: nixpkgs=https://github.com/NixOS/nixpkgs/archive/6625284c397b44bc9518a5a1567c1b5aae455c08.tar.gz
    - uses: cachix/cachix-action@v8
      with:
        name: itprotv-bazel-test
        # If you chose signing key for write access
        signingKey: '${{ secrets.CACHIX_SIGNING_KEY }}'
        # If you chose API tokens for write access OR if you have a private cache
        authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
    - run: nix-shell --run "echo OK"
    - name: Mount bazel cache
      uses: actions/cache@v2
      with:
        path: "/home/runner/.cache/bazel"
        key: bazel
    - run: nix-shell --pure --run "bazel build ..."
